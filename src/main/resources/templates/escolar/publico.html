<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{master}">
<head>
  <meta charset="UTF-8">
  <title>Lista escolar | Papelería Interstellar</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    .item-row input, .item-row select { min-width: 120px; }
  </style>
</head>
<body class="bg-light">
<nav th:replace="layouts/navbar :: navbar"></nav>
<main class="container py-4" layout:fragment="contenido">
  <h1 class="h4 mb-3">Cotiza tu lista escolar</h1>
  <p class="text-muted mb-1">Agrega los artículos que necesites (cuadernos, esferos, blocks, carpetas, cartulinas, etc.).</p>
  <p class="text-muted small">Tip: escribe 2 letras en “Producto” y elige una sugerencia para traer precio y stock.</p>

  <div class="table-responsive bg-white shadow-sm rounded p-3">
    <table class="table align-middle mb-0 subtable" id="itemsTable">
      <thead>
      <tr>
        <th>Categoría</th>
        <th>Producto</th>
        <th>Cant.</th>
        <th>Precio</th>
        <th>Stock</th>
        <th></th>
      </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <button class="btn btn-outline-primary btn-sm mt-2" onclick="addRow()">Agregar ítem</button>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <div class="fw-semibold">Total: $<span id="totalSpan">0</span></div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" th:href="@{/shop}">Volver a tienda</a>
      <button class="btn btn-secondary" onclick="window.print()">Imprimir</button>
      <a id="waLink" class="btn btn-success" target="_blank" href="#">Enviar WhatsApp</a>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const categorias = [
    'Cuadernos', 'Lápices', 'Esferos', 'Blocks', 'Carpetas',
    'Pegantes', 'Borradores', 'Tijeras', 'Reglas', 'Compás', 'Cartulinas', 'Marcadores'
  ];

  function uid(){ return `sug-${Date.now()}-${Math.random().toString(16).slice(2)}`; }

  function addRow(item = {}) {
    const tbody = document.querySelector('#itemsTable tbody');
    const listId = uid();
    const tr = document.createElement('tr');
    tr.className = 'item-row';
    tr.innerHTML = `
      <td>
        <select class="form-select form-select-sm cat">
          ${categorias.map(c => `<option ${item.cat===c?'selected':''}>${c}</option>`).join('')}
        </select>
      </td>
      <td>
        <input list="${listId}" class="form-control form-control-sm producto" placeholder="Buscar producto" value="${item.prod||''}">
        <datalist id="${listId}"></datalist>
        <div class="small text-muted info"></div>
      </td>
      <td><input type="number" min="1" class="form-control form-control-sm qty" value="${item.qty||1}"></td>
      <td><input type="number" min="0" step="50" class="form-control form-control-sm price" value="${item.price||''}" placeholder="Opcional (se autocompleta si existe)"></td>
      <td class="stock text-muted">${item.stock||''}</td>
      <td><button class="btn btn-link text-danger" onclick="removeRow(this)">Quitar</button></td>
    `;
    tbody.appendChild(tr);
    attachAutocomplete(tr);
    recalc();
  }

  function removeRow(btn){
    btn.closest('tr').remove();
    recalc();
  }

  function recalc(){
    let total = 0;
    const lines = [];
    document.querySelectorAll('.item-row').forEach(row=>{
      const cat = row.querySelector('.cat').value.trim();
      const prod = row.querySelector('.producto').value.trim();
      const qty = parseFloat(row.querySelector('.qty').value) || 0;
      const price = parseFloat(row.querySelector('.price').value) || 0;
      const stock = row.querySelector('.stock').textContent.trim();
      if (qty > 0) {
        if (price > 0) total += qty * price;
        lines.push({cat, prod, qty, price, stock});
      }
    });
    document.getElementById('totalSpan').textContent = total.toLocaleString('es-CO', {minimumFractionDigits: 0});
    const msg = buildMessage(lines, total);
    document.getElementById('waLink').href = `https://wa.me/573142649585?text=${encodeURIComponent(msg)}`;
  }

  function buildMessage(lines, total){
    let msg = 'Hola! Cotiza mi lista escolar:%0A';
    lines.forEach(l=>{
      const precio = l.price>0 ? ` - Precio: $${l.price}` : '';
      const prod = l.prod ? ` (${l.prod})` : '';
      const stock = l.stock ? ` - Stock: ${l.stock}` : '';
      msg += `• ${l.qty} x ${l.cat}${prod}${precio}${stock}%0A`;
    });
    msg += `Total estimado: $${total.toLocaleString('es-CO', {minimumFractionDigits:0})}`;
    return msg;
  }

  document.addEventListener('input', (e)=>{
    if (e.target.closest('.item-row')) recalc();
  });
  document.addEventListener('change', (e)=>{
    if (e.target.closest('.item-row')) recalc();
  });

  document.addEventListener('DOMContentLoaded', addRow); // fila inicial

  function attachAutocomplete(row){
    const prodInput = row.querySelector('.producto');
    const priceInput = row.querySelector('.price');
    const catSelect = row.querySelector('.cat');
    const datalist = row.querySelector('datalist');
    const info = row.querySelector('.info');
    const stockCell = row.querySelector('.stock');

    let timer;
    prodInput.addEventListener('input', ()=>{
      clearTimeout(timer);
      timer = setTimeout(async ()=>{
        const term = prodInput.value.trim();
        const cat = catSelect.value;
        if (term.length < 2) { datalist.innerHTML=''; info.textContent=''; stockCell.textContent=''; return; }
        try{
          const resp = await fetch(`/api/escolar/productos?q=${encodeURIComponent(term)}&categoria=${encodeURIComponent(cat)}`);
          if (!resp.ok) return;
          const data = await resp.json();
          datalist.innerHTML = data.map(d => {
            const precio = d.precio != null ? ` - $${d.precio}` : '';
            const stock = d.existencia != null ? ` (stock: ${d.existencia})` : '';
            return `<option value="${d.nombre}">${d.codigo || ''}${precio}${stock}</option>`;
          }).join('');
          prodInput.onchange = ()=>{
            const match = data.find(d => d.nombre === prodInput.value);
            if (match) {
              if (match.precio != null) priceInput.value = match.precio;
              const stockTxt = match.existencia!=null ? match.existencia : '';
              stockCell.textContent = stockTxt;
              info.textContent = `Precio: $${match.precio ?? 'N/A'}${stockTxt!=='' ? ' | Stock: '+stockTxt : ''}`;
            } else {
              info.textContent = '';
              stockCell.textContent = '';
            }
            recalc();
          };
        }catch(e){ console.error(e); }
      }, 300);
    });
  }
</script>
</body>
</html>
