<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{master}">
<head>
  <meta charset="UTF-8">
  <title>Lista escolar - Vendedor | Papeleria Interstellar</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    .item-row input, .item-row select { min-width: 120px; }
  </style>
</head>
<body class="bg-light">
<nav th:replace="layouts/navbar :: navbar"></nav>
<main class="container py-4" layout:fragment="contenido">
  <h1 class="h4 mb-3">Cotización escolar (Vendedor)</h1>
  <p class="text-muted mb-1">Agrega ítems, ajusta precios y marca disponibilidad.</p>
  <p class="text-muted small">Tip: escribe 2 letras en "Producto" y elige una sugerencia para traer precio y stock.</p>

  <div class="table-responsive bg-white shadow-sm rounded p-3">
    <table class="table align-middle mb-0 subtable" id="itemsTable">
      <thead>
      <tr>
        <th>Categoría</th>
        <th>Producto</th>
        <th>Cant.</th>
        <th>Precio</th>
        <th>Stock</th>
        <th>Disp.</th>
        <th></th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="addRowBtn" class="btn btn-outline-primary btn-sm mt-2">Agregar ítem</button>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <div>
      <div class="fw-semibold">Total: $<span id="totalSpan">0</span></div>
      <small id="stockNote" class="text-muted"></small>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" th:href="@{/shop}">Volver a tienda</a>
      <button class="btn btn-secondary" onclick="window.print()">Imprimir</button>
      <a id="waLink" class="btn btn-success" target="_blank" href="#">Enviar WhatsApp</a>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
  const categorias = [
    { label: 'Todas', value: '' },
    { label: 'Cuadernos', value: 'Cuadernos' },
    { label: 'Lapices', value: 'Lápices' },
    { label: 'Esferos', value: 'Esferos' },
    { label: 'Blocks', value: 'Blocks' },
    { label: 'Carpetas', value: 'Carpetas' },
    { label: 'Pegantes', value: 'Pegantes' },
    { label: 'Borradores', value: 'Borradores' },
    { label: 'Tijeras', value: 'Tijeras' },
    { label: 'Reglas', value: 'Reglas' },
    { label: 'Compas', value: 'Compás' },
    { label: 'Cartulinas', value: 'Cartulinas' },
    { label: 'Marcadores', value: 'Marcadores' }
  ];

  // Lista completa de productos desde el backend (nombre, codigo, precio, existencia, area)
  const productos = /*[[${productos}]]*/ || [];

  function uid() {
    return `sug-${Date.now()}-${Math.random().toString(16).slice(2)}`;
  }

  function addRow(item = {}) {
    const tbody = document.querySelector('#itemsTable tbody');
    const listId = uid();
    const tr = document.createElement('tr');
    tr.className = 'item-row';
    tr.innerHTML = `
      <td>
        <select class="form-select form-select-sm cat">
          ${categorias.map(c => `<option value="${c.value}" ${item.cat===c.value?'selected':''}>${c.label}</option>`).join('')}
        </select>
      </td>
      <td>
        <input list="${listId}" class="form-control form-control-sm producto" placeholder="Buscar producto" value="${item.prod||''}">
        <datalist id="${listId}"></datalist>
        <div class="small text-muted info"></div>
      </td>
      <td><input type="number" min="1" class="form-control form-control-sm qty" value="${item.qty||1}"></td>
      <td><input type="number" min="0" step="50" class="form-control form-control-sm price" value="${item.price||''}" placeholder="Precio"></td>
      <td class="stock text-muted">${item.stock||''}</td>
      <td class="text-center">
        <input type="checkbox" class="form-check-input avail" ${item.avail?'checked':''} title="Disponible">
      </td>
      <td><button class="btn btn-link text-danger" onclick="removeRow(this)">Quitar</button></td>
    `;
    tbody.appendChild(tr);
    attachAutocomplete(tr);
    recalc();
  }

  function removeRow(btn){
    btn.closest('tr').remove();
    recalc();
  }

  function recalc(){
    let total = 0;
    let agotados = 0;
    const lines = [];
    document.querySelectorAll('.item-row').forEach(row=>{
      const cat = row.querySelector('.cat').value.trim();
      const prod = row.querySelector('.producto').value.trim();
      const qty = parseFloat(row.querySelector('.qty').value) || 0;
      const price = parseFloat(row.querySelector('.price').value) || 0;
      const avail = row.querySelector('.avail').checked;
      const stock = row.querySelector('.stock').textContent.trim();
      if (qty > 0) {
        if (price > 0) total += qty * price;
        if (!avail) agotados++;
        lines.push({cat, prod, qty, price, avail, stock});
      }
    });
    document.getElementById('totalSpan').textContent = total.toLocaleString('es-CO', {minimumFractionDigits: 0});
    document.getElementById('stockNote').textContent = agotados>0 ? `${agotados} item(s) sin stock` : '';
    const msg = buildMessage(lines, total);
    document.getElementById('waLink').href = `https://wa.me/573142649585?text=${encodeURIComponent(msg)}`;
  }

  function buildMessage(lines, total){
    let msg = 'Hola! Cotizacion escolar:%0A';
    lines.forEach(l=>{
      const precio = l.price>0 ? ` - Precio: $${l.price}` : '';
      const prod = l.prod ? ` (${l.prod})` : '';
      const stock = l.stock ? ` - Stock: ${l.stock}` : '';
      const disp = l.avail ? '' : ' [Sin stock]';
      msg += `• ${l.qty} x ${l.cat}${prod}${precio}${stock}${disp}%0A`;
    });
    msg += `Total estimado: $${total.toLocaleString('es-CO', {minimumFractionDigits:0})}`;
    return msg;
  }

  document.addEventListener('input', (e)=>{
    if (e.target.closest('.item-row')) recalc();
  });
  document.addEventListener('change', (e)=>{
    if (e.target.closest('.item-row')) recalc();
  });

  document.addEventListener('DOMContentLoaded', ()=>{
    addRow();
    const addBtn = document.getElementById('addRowBtn');
    if (addBtn) addBtn.addEventListener('click', (e)=>{ e.preventDefault(); addRow(); });
  });

  function attachAutocomplete(row){
    const prodInput = row.querySelector('.producto');
    const priceInput = row.querySelector('.price');
    const catSelect = row.querySelector('.cat');
    const datalist = row.querySelector('datalist');
    const info = row.querySelector('.info');
    const stockCell = row.querySelector('.stock');
    const availCheck = row.querySelector('.avail');

    let timer;
    prodInput.addEventListener('input', ()=>{
      clearTimeout(timer);
      timer = setTimeout(async ()=>{
        const term = prodInput.value.trim();
        const cat = catSelect.value;
        const results = productos.filter(p=>{
          const t = term.toLowerCase();
          const matchesTerm = p.nombre?.toLowerCase().includes(t) || p.codigo?.toLowerCase().includes(t);
          const matchesCat = !cat || !p.area ? true : p.area === cat;
          return matchesTerm && matchesCat;
        });
        datalist.innerHTML = results.map(d => {
          const precio = d.precio != null ? ` - $${d.precio}` : '';
          const stock = d.existencia != null ? ` (stock: ${d.existencia})` : '';
          return `<option value="${d.nombre}">${d.codigo || ''}${precio}${stock}</option>`;
        }).join('');
        prodInput.onchange = ()=>{
          const match = results.find(d => d.nombre === prodInput.value);
          if (match) {
            if (match.precio != null) priceInput.value = match.precio;
            const stockTxt = match.existencia!=null ? match.existencia : '';
            stockCell.textContent = stockTxt;
            availCheck.checked = match.existencia == null ? true : match.existencia > 0;
            info.textContent = `Precio: $${match.precio ?? 'N/A'}${stockTxt!=='' ? ' | Stock: '+stockTxt : ''}`;
          } else {
            info.textContent = '';
            stockCell.textContent = '';
          }
          recalc();
        };
      }, 300);
    });
  }
</script>
</main>
</body>
</html>
